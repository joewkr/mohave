language: c
os: linux
dist: bionic

cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store
    - $HOME/.hlint
before_cache:
  - rm -fv $CABALHOME/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $CABALHOME/packages/hackage.haskell.org/00-index.*
  - rm -fv $CABALHOME/packages/hackage.haskell.org/*.json
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.cache
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.tar
  - rm -fv $CABALHOME/packages/hackage.haskell.org/01-index.tar.idx
  - rm -rfv $CABALHOME/packages/head.hackage

addons:
  apt:
    packages: &native_deps
      - libhdf4-alt-dev

jobs:
  include:
    - compiler: ghc-8.4.4
      addons:
        apt:
          sources:
            - hvr-ghc
          packages:
            - *native_deps
            - ghc-8.4.4
            - cabal-install-2.2
      os: linux
    - compiler: ghc-8.6.5
      addons:
        apt:
          sources:
            - hvr-ghc
          packages:
            - *native_deps
            - ghc-8.6.5
            - cabal-install-2.4
      os: linux
    - compiler: ghc-8.8.4
      addons:
        apt:
          sources:
            - hvr-ghc
          packages:
            - *native_deps
            - ghc-8.8.4
            - cabal-install-3.0
      os: linux
#   - compiler: ghc-8.10.2
#     addons:
#       apt:
#         sources:
#           - hvr-ghc
#         packages:
#           - *native_deps
#           - ghc-8.10.2
#           - cabal-install-3.2
#     os: linux

before_install:
  - GHCBIN=$(echo "/opt/${CC}/bin" | sed 's/-/\//')
  - unset CC
  - CABALBIN=/opt/ghc/bin/
  - CABALHOME=$HOME/.cabal
  - export PATH="${GHCBIN}:${CABALBIN}:${CABALHOME}/bin:$PATH"
  - export PKG_CONFIG_PATH="${TRAVIS_BUILD_DIR}:${PKG_CONFIG_PATH}"
  - export CABAL_VER=`cabal --numeric-version`
  - |
    echo 'libdir=/usr/lib/'                                                       >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'includedir=/usr/include/hdf/'                                           >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'ccompiler=/usr/bin/cc'                                                  >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'Name: hdf'                                                              >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'Description: HDF Library for C'                                         >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'URL: https://www.hdfgroup.org/solutions/hdf4/'                          >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'Version: 4.2.13'                                                        >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'Libs: -L${libdir} -lmfhdfalt -ldfalt -Wl,-rpath,${libdir} -lz -ldl -lm' >> ${TRAVIS_BUILD_DIR}/hdf.pc
    echo 'Cflags: -I${includedir}'                                                >> ${TRAVIS_BUILD_DIR}/hdf.pc
  # This term is spelled differently in vanilla HDF library and in the version provided with Ubuntu. So,
  # for Travis CI just replace the word in question while keeping the original spelling in the repository.
  - sed --in-place 's/syncronize/synchronize/g' ${TRAVIS_BUILD_DIR}/test/Data/Format/HDF/LowLevel/HESpec.hs
install:
  - cabal update
  - |
    if `dpkg --compare-versions $CABAL_VER ge 3.0`; then
      cabal build   --only-dependencies --enable-test
    else
      cabal install --only-dependencies --enable-tests
    fi
script:
  - |
    if `dpkg --compare-versions $CABAL_VER ge 3.0`; then
      export CABAL_TEST_OUTPUT_MODE=test-show-details
    else
      export CABAL_TEST_OUTPUT_MODE=show-details
    fi
  - cabal configure --enable-tests
  - cabal build
  - cabal test --${CABAL_TEST_OUTPUT_MODE}=direct
